void twi_init(void)
{
    TWCR= 0x00; //终止I2C twi
    TWBR= 0x32; //设置传输速率（中速） 
    TWSR=?0x00;?//设置预分步值（0分频）
    TWAR=?0x00;?//设置从机地址（因为是主机模式，此处可以不用）
    TWCR=?0x04;?//开启I2C??twi
}
?/*--------------------------总线启动开始START---------------------------------*/?
?void?i2cstart(void)
{
    TWCR=?BIT(TWINT)?|?BIT(TWSTA)?|?BIT(TWEN);
    while?(!(TWCR?&?BIT(TWINT)));??
}

/*-----------------------总线上写入一个字节返回TWI状态------------------------*/??
uchar?i2cwt(uchar?a)
{
    TWDR?=?a;
    ?TWCR?=?BIT(TWINT)?|?BIT(TWEN);?
    while?(!(TWCR?&?BIT(TWINT)));
    ?_NOP();
    ?return(TWSR&0xF8);
    
}

/*----------------------总线上读出一个字节返回所读数据------------------------*/
uchar?i2crd(void)
{
  TWCR=?BIT(TWINT)?|?BIT(TWEA)?|?BIT(TWEN);
  while?(!(TWCR?&?BIT(TWINT)));
  return(TWDR);  
}

/*--------------------------总线结束停止STOP----------------------------------*/
void?i2cstop(void)
{
  TWCR?=?BIT(TWINT)?|?BIT(TWSTO)?|?BIT(TWEN);  
}
?/*----------------------------------------------------------------------------*/???? 87.?/*???????????????????????向数字定位器内选定某个定位器写入所需数据?????????????*/???????????????????88.?/*????????????参数说明:??dcp_n??要写入数据的内部某个电位器的子地址????????????*/???????????89.?/*???????????????????????number?要写入此电位器的数 据??????????????????????????*/???????????????????????????????????????????????????????????????90.?/*----------------------------------------------------------------------------*/
void??wt24c_dwq(?uchar?dcp_n,uchar?number)?
{
  if(number=0x255)???????????//数据不得超过255
    {
      ?i2cstart();??????????????//发送起始信号?
      if(i2cwt(W_ADD)==SLAW)???//发送SLA_W,?写字节命令及主器件地址?
        {
            i2cwt(dcp_n);???????????//写字节命令及器件内部子地址
            i2cwt(number);??????????//向所选定的定位器写入所需数据
        }  
        i2cstop();???????????????//发送停止信号
        tms(6);??????????????????//延时6ms，完成写入??
    }  
}


?/*----------------------------------------------------------------------------*/????108.?/*?????????????????????从数字定位器内按顺序读出所有数据???????????????????????*/??????109.?/*????????????参数说明:??*r_data要读入数据的主机内存地址指 针??????????????????*/???????????????????????????????????????????????????????????????110.?/*----------------------------------------------------------------------------*/

?void?rd24c_n(?uchar?*r_data)
{
  uchar?i;?
  i2cstart();???????????????//发送起始信号
  if(i2cwt(W_ADD)==SLAW)????//发送SLA_W,?写字节命令及主器件地址
    {
        i2cwt(DCP_0);???????????//写字节命令及器件内部第一个子地址
        i2cstart();?????????????//再次发送起始信号
        i2cwt(R_ADD);???????????//读命令字节及主器件地址
        for(i=0;i<4;i++)?
        {
          *r_data=i2crd();???????//依次从器件读出数据，4个电位器则共4个字节数据??
          r_data++;?  
        }    
        
    }
      i2cstop();????????????????//读完成停止结束
}

?/*-----------------------------对端口进行初初化-------------------------------*/
void?port_init(void)
{
  PORTA?=?0x00;????//PORTA口初始设置为输出0????? 133.??DDRA??=?0xFF;????//PORTA口设置为输出方式（用于数码管显示所读数据）?????134.??PORTB?=?0xFF;????135.??DDRB??=?0x00;???? 136.??PORTC?=?0xFF;????????????137.??DDRC??=?0x00;????138.??PORTD?=?0xFF;????139.??DDRD??=?0xFF;?  
}


